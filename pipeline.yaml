# Request to Proposal Workflow - StageFlow Configuration
# Version: 2.4.0
# Updated: 2025-11-18
# Changes from v2.3.0:
#   - Synchronized with stage definitions (validation fixes)
#   - Renamed 'approval_review' stage to 'selection' to match stage definitions
#   - Restored revision loop: added proposal_requires_rethink gate (selectionâ†’drafting)
#   - Updated property paths to match nested structure in stage definitions
#   - Updated gate names to match stage definition specifications
#   - Property structure: Using nested paths (frontmatter.*, content.sections.*)
# Changes from v2.2.0:
#   - Fixed 13 incomplete greater_than locks that prevented workflow execution
#   - All locks now have complete property_path, expected_value, and error_message
#   - Removed expected_properties sections (caused StageFlow validation conflicts)
#   - Added missing gate lock for scoping.out_of_scope
# Changes from v2.1.0:
#   - Enhanced expected_actions structure with purpose and template references
#   - Added inline templates section for each stage with schema definitions
#   - Templates now include path, purpose, and expected data structure
#   - Actions now reference which templates they use
# Changes from v2.0.0:
#   - Added expected_properties and expected_actions metadata to all stages
#
# This workflow transforms ideas, requests, epics, and bug reports into
# evaluated implementation proposals through systematic analysis and assessment.

process:
  name: request_to_proposal
  description: Transform requests into evaluated implementation proposals
  initial_stage: intake
  final_stage: closed
  stage_prop: "workflow.stage"

  stages:
    # ==================================================================
    # STAGE: Intake - Initial request capture and categorization
    # ==================================================================
    intake:
      # Expected actions following StageFlow schema
      expected_actions:
        - description: "Categorize Request Type"
          related_properties:
            - frontmatter.request_type
          template: "intake_form"  # References template by name
        - description: "Assign Initial Priority"
          related_properties:
            - intake.priority
          template: "priority_assessment"  # References template by name
        - description: "Assign to Analyst"
          related_properties:
            - intake.assigned_to
            - intake.assigned_at
        - description: "Complete Intake Review"
          related_properties:
            - intake.reviewed
            - intake.reviewed_at
            - intake.reviewed_by

      # Templates defined as array following StageFlow schema
      templates:
        - name: "intake_form"
          description: "Template for request categorization"
          frontmatter:
            request_type: "{type}"  # Placeholder
          sections:
            - id: "description"
              title: "Request Description"
              level: 1
              content: "Describe the request in detail"

        - name: "priority_assessment"
          description: "Template for priority determination"
          parameters:
            - name: "priority"
              required: true
              description: "Priority level"
              placeholder: "critical|high|medium|low"
          frontmatter:
            priority: "{priority}"  # Placeholder

      schema:
        required_fields:
          - created_at
          - title
          - description

      gates:
        ready_for_scoping:
          target_stage: scoping
          locks:
            - exists: "frontmatter.request_type"
              error_message: "Request must be categorized. Please specify type: idea, user_request, epic, or bug_report"

            - type: "in_list"
              property_path: "frontmatter.request_type"
              expected_value: ["idea", "user_request", "epic", "bug_report"]
              error_message: "Request type must be one of: idea, user_request, epic, bug_report"

            - exists: "intake.priority"
              error_message: "Priority must be assigned before scoping can begin"

            - type: "in_list"
              property_path: "intake.priority"
              expected_value: ["critical", "high", "medium", "low"]
              error_message: "Priority must be one of: critical, high, medium, low"

            - exists: "intake.assigned_to"
              error_message: "Request must be assigned to an analyst"

            - exists: "intake.assigned_at"
              error_message: "Assignment timestamp must be recorded"

            - type: "equals"
              property_path: "intake.reviewed"
              expected_value: true
              error_message: "Intake review must be completed before proceeding to scoping"

            - exists: "intake.reviewed_at"
              error_message: "Review timestamp must be recorded"

            - exists: "intake.reviewed_by"
              error_message: "Reviewer must be recorded"

    # ==================================================================
    # STAGE: Scoping - Define objectives, scope, and success criteria
    # ==================================================================
    scoping:
      # Expected actions following StageFlow schema
      expected_actions:
        - description: "Define Objectives"
          related_properties:
            - "content.sections.context.objectives"
          template: "objectives"  # Singular, references template by name

        - description: "Identify Success Metrics"
          related_properties:
            - "content.sections.context.success_metrics"
          template: "objectives"  # Singular, references template by name

        - description: "Define In-Scope Items"
          related_properties:
            - "content.sections.context.boundaries.included"
          template: "scope_definition"  # Singular, references template by name

        - description: "Define Out-of-Scope Items"
          related_properties:
            - "content.sections.context.boundaries.excluded"
          template: "boundaries"  # Singular, references template by name

        - description: "Complete Scoping Review"
          related_properties:
            - "scoping.completed"
            - "scoping.completed_at"
            - "scoping.completed_by"

      # Templates defined as array following StageFlow schema
      templates:
        - name: "objectives"
          description: "Template for defining objectives and success metrics"
          sections:
            - id: "objectives"
              title: "Objectives"
              level: 1
              content: "Define specific objectives"
            - id: "success_metrics"
              title: "Success Metrics"
              level: 1
              content: "Define measurable success criteria"

        - name: "scope_definition"
          description: "Template for defining in-scope items"
          sections:
            - id: "in_scope"
              title: "In Scope"
              level: 1
              content: "List items included in scope"

        - name: "boundaries"
          description: "Template for defining scope boundaries"
          sections:
            - id: "out_of_scope"
              title: "Out of Scope"
              level: 1
              content: "List items explicitly excluded"

      gates:
        ready_for_triage:
          target_stage: triage
          locks:
            - exists: "content.sections.context.objectives"
              error_message: "Objectives must be defined before triage. Please document what this request aims to achieve"

            - type: "greater_than"
              property_path: "length(content.sections.context.objectives)"
              expected_value: 0
              error_message: "At least one objective must be defined"

            - exists: "content.sections.context.boundaries.included"
              error_message: "In-scope items must be defined to establish boundaries"

            - type: "greater_than"
              property_path: "length(content.sections.context.boundaries.included)"
              expected_value: 0
              error_message: "At least one in-scope item must be defined"

            - exists: "content.sections.context.boundaries.excluded"
              error_message: "Out-of-scope items must be defined to prevent scope creep"

            - type: "greater_than"
              property_path: "length(content.sections.context.boundaries.excluded)"
              expected_value: 0
              error_message: "At least one out-of-scope item must be defined"

            - exists: "content.sections.context.success_metrics"
              error_message: "Success metrics must be identified to measure achievement"

            - type: "greater_than"
              property_path: "length(content.sections.context.success_metrics)"
              expected_value: 0
              error_message: "At least one success metric must be identified"

            - type: "equals"
              property_path: "scoping.completed"
              expected_value: true
              error_message: "Scoping review must be completed before proceeding to triage"

            - exists: "scoping.completed_at"
              error_message: "Scoping completion timestamp must be recorded"

            - exists: "scoping.completed_by"
              error_message: "Person completing scoping must be recorded"

    # ==================================================================
    # STAGE: Triage - Impact and context analysis
    # ==================================================================
    triage:
      # Expected actions following StageFlow schema
      expected_actions:
        - description: "Document Current Capabilities"
          related_properties:
            - "content.sections.current.current_functionality.capabilities"
          template: "affected_modules"  # Singular, references template by name

        - description: "Document Current Limitations"
          related_properties:
            - "content.sections.current.current_functionality.limitations"
          template: "affected_modules"  # Singular, references template by name

        - description: "Identify Affected Modules"
          related_properties:
            - "content.sections.current.modules"
          template: "affected_modules"  # Singular, references template by name

        - description: "Identify Affected Artifacts"
          related_properties:
            - "content.sections.current.artifacts"
          template: "triage_context"  # Singular, references template by name

        - description: "Identify Affected Files"
          related_properties:
            - "content.sections.current.files"
          template: "triage_context"  # Singular, references template by name

        - description: "Complete Triage Analysis"
          related_properties:
            - "triage.completed"
            - "triage.completed_at"
            - "triage.completed_by"

      # Templates defined as array following StageFlow schema
      templates:
        - name: "affected_modules"
          description: "Template for documenting affected systems"
          sections:
            - id: "affected_systems"
              title: "Affected Systems"
              level: 1
              content: "List systems impacted by this change"

        - name: "triage_context"
          description: "Template for impact analysis"
          parameters:
            - name: "impact_level"
              required: true
              description: "Impact level assessment"
              placeholder: "critical|high|medium|low"
          frontmatter:
            impact_level: "{impact_level}"
          sections:
            - id: "stakeholders"
              title: "Stakeholders"
              level: 1
              content: "List affected stakeholders"
            - id: "impact_assessment"
              title: "Impact Assessment"
              level: 1
              content: "Assess overall impact"

      gates:
        ready_for_drafting:
          target_stage: drafting
          locks:
            - exists: "content.sections.current.current_functionality.capabilities"
              error_message: "Current capabilities must be documented before creating proposal"

            - type: "greater_than"
              property_path: "length(content.sections.current.current_functionality.capabilities)"
              expected_value: 0
              error_message: "Current capabilities documentation must be substantive"

            - exists: "content.sections.current.current_functionality.limitations"
              error_message: "Current limitations must be documented to understand gaps"

            - type: "greater_than"
              property_path: "length(content.sections.current.current_functionality.limitations)"
              expected_value: 0
              error_message: "Current limitations documentation must be substantive"

            - exists: "content.sections.current.modules"
              error_message: "Affected modules must be identified"

            - type: "greater_than"
              property_path: "length(content.sections.current.modules)"
              expected_value: 0
              error_message: "At least one affected module must be identified"

            - exists: "content.sections.current.artifacts"
              error_message: "Affected artifacts must be identified"

            - type: "greater_than"
              property_path: "length(content.sections.current.artifacts)"
              expected_value: 0
              error_message: "At least one affected artifact must be identified"

            - exists: "content.sections.current.files"
              error_message: "Affected files must be identified"

            - type: "greater_than"
              property_path: "length(content.sections.current.files)"
              expected_value: 0
              error_message: "At least one affected file must be identified"

            - type: "equals"
              property_path: "triage.completed"
              expected_value: true
              error_message: "Triage analysis must be completed before proceeding to proposal drafting"

            - exists: "triage.completed_at"
              error_message: "Triage completion timestamp must be recorded"

            - exists: "triage.completed_by"
              error_message: "Person completing triage must be recorded"

    # ==================================================================
    # STAGE: Drafting - Create implementation proposal
    # ==================================================================
    drafting:
      # Expected actions following StageFlow schema
      expected_actions:
        - description: "Create Solution Alternatives"
          related_properties:
            - "content.sections.proposal.alternatives"
          template: "implementation_approach"  # Singular, references template by name

        - description: "Define Verification Methods"
          related_properties:
            - "content.sections.proposal.verification_methods"
          template: "verification_methods"  # Singular, references template by name

        - description: "Define Acceptance Criteria"
          related_properties:
            - "content.sections.proposal.acceptance_criteria"
          template: "acceptance_criteria"  # Singular, references template by name

        - description: "Complete Draft"
          related_properties:
            - "proposal.draft_completed"
            - "proposal.draft_completed_at"
            - "proposal.draft_completed_by"

      # Templates defined as array following StageFlow schema
      templates:
        - name: "implementation_approach"
          description: "Template for documenting implementation strategy"
          sections:
            - id: "approach"
              title: "Implementation Approach"
              level: 1
              content: "Describe how the proposal will be implemented"

        - name: "change_plan"
          description: "Template for listing specific changes"
          sections:
            - id: "changes"
              title: "Change Plan"
              level: 1
              content: "List specific changes to be made"

        - name: "verification_methods"
          description: "Template for verification planning"
          sections:
            - id: "verification"
              title: "Verification Methods"
              level: 1
              content: "Define how implementation will be verified"

        - name: "acceptance_criteria"
          description: "Template for acceptance criteria"
          sections:
            - id: "criteria"
              title: "Acceptance Criteria"
              level: 1
              content: "Define criteria for proposal acceptance"

      gates:
        ready_for_evaluation:
          target_stage: evaluation
          locks:
            - exists: "content.sections.proposal.alternatives"
              error_message: "Solution proposals must be created before evaluation"

            - type: "greater_than"
              property_path: "length(content.sections.proposal.alternatives)"
              expected_value: 1
              error_message: "At least 2 solution alternatives must be created"

            - exists: "content.sections.proposal.verification_methods"
              error_message: "Verification methods must be defined to validate implementation"

            - type: "greater_than"
              property_path: "length(content.sections.proposal.verification_methods)"
              expected_value: 0
              error_message: "At least one verification method must be defined"

            - exists: "content.sections.proposal.acceptance_criteria"
              error_message: "Acceptance criteria must be defined for proposal approval"

            - type: "greater_than"
              property_path: "length(content.sections.proposal.acceptance_criteria)"
              expected_value: 0
              error_message: "At least one acceptance criterion must be defined"

            - type: "equals"
              property_path: "proposal.draft_completed"
              expected_value: true
              error_message: "Proposal draft must be completed before proceeding to evaluation"

            - exists: "proposal.draft_completed_at"
              error_message: "Draft completion timestamp must be recorded"

            - exists: "proposal.draft_completed_by"
              error_message: "Person completing draft must be recorded"

    # ==================================================================
    # STAGE: Evaluation - Critical assessment of proposal
    # ==================================================================
    evaluation:
      # Expected actions following StageFlow schema
      expected_actions:
        - description: "Score Proposals"
          related_properties:
            - "content.sections.evaluation.scores"
          template: "proposal_assessment"  # Singular, references template by name

        - description: "Explain Scores"
          related_properties:
            - "content.sections.evaluation.explanations"
          template: "proposal_assessment"  # Singular, references template by name

        - description: "Identify Recommended Proposal"
          related_properties:
            - "content.sections.evaluation.recommended_proposal"
          template: "proposal_assessment"  # Singular, references template by name

        - description: "Provide Recommendation Rationale"
          related_properties:
            - "content.sections.evaluation.recommendation_rationale"
          template: "proposal_assessment"  # Singular, references template by name

        - description: "Complete Evaluation"
          related_properties:
            - "evaluation.completed"
            - "evaluation.completed_at"
            - "evaluation.completed_by"

      # Templates defined as array following StageFlow schema
      templates:
        - name: "proposal_assessment"
          description: "Template for critical evaluation"
          parameters:
            - name: "complexity"
              required: true
              description: "Complexity level"
              placeholder: "low|medium|high|very_high"
            - name: "recommendation"
              required: true
              description: "Recommendation decision"
              placeholder: "approve|reject|split|revise"
          frontmatter:
            complexity_level: "{complexity}"
            recommendation: "{recommendation}"
          sections:
            - id: "objective_alignment"
              title: "Objective Alignment"
              level: 1
              content: "Assess alignment with objectives"
            - id: "technical_feasibility"
              title: "Technical Feasibility"
              level: 1
              content: "Evaluate technical soundness"
            - id: "recommendation_rationale"
              title: "Recommendation Rationale"
              level: 1
              content: "Explain recommendation reasoning"

      gates:
        ready_for_selection:
          target_stage: selection
          locks:
            - exists: "content.sections.evaluation.recommended_proposal"
              error_message: "Recommended solution must be identified"

            - type: "greater_than"
              property_path: "length(content.sections.evaluation.recommended_proposal)"
              expected_value: 0
              error_message: "Recommended proposal name must be specified"

            - exists: "content.sections.evaluation.recommendation_rationale"
              error_message: "Recommendation rationale must be provided to support decision"

            - type: "greater_than"
              property_path: "length(content.sections.evaluation.recommendation_rationale)"
              expected_value: 99
              error_message: "Recommendation rationale must be substantive (at least 100 characters)"

            - exists: "content.sections.evaluation.scores"
              error_message: "Proposals must be scored across evaluation dimensions"

            - type: "greater_than"
              property_path: "length(content.sections.evaluation.scores)"
              expected_value: 0
              error_message: "At least one proposal must be scored"

            - exists: "content.sections.evaluation.explanations"
              error_message: "Score explanations must be provided for each proposal"

            - type: "greater_than"
              property_path: "length(content.sections.evaluation.explanations)"
              expected_value: 0
              error_message: "At least one score explanation must be provided"

            - type: "equals"
              property_path: "evaluation.completed"
              expected_value: true
              error_message: "Evaluation must be completed before approval review"

            - exists: "evaluation.completed_at"
              error_message: "Evaluation completion timestamp must be recorded"

            - exists: "evaluation.completed_by"
              error_message: "Person completing evaluation must be recorded"

    # ==================================================================
    # STAGE: Selection - Final decision on proposal
    # ==================================================================
    selection:
      # Expected actions following StageFlow schema
      expected_actions:
        - description: "Make Proposal Decision"
          related_properties:
            - "frontmatter.proposal_decision"
          template: "proposal_decision"  # Singular, references template by name

        - description: "Document Selected Solution"
          related_properties:
            - "content.sections.decision.selected_solution"
          template: "proposal_decision"  # Singular, references template by name

        - description: "Document Decision Observations"
          related_properties:
            - "content.sections.decision.observations"
          template: "proposal_decision"  # Singular, references template by name

      # Templates defined as array following StageFlow schema
      templates:
        - name: "proposal_decision"
          description: "Template for final approval decision"
          parameters:
            - name: "decision"
              required: true
              description: "Final decision"
              placeholder: "approved|rejected|split_required"
          frontmatter:
            decision: "{decision}"
          sections:
            - id: "decision_rationale"
              title: "Decision Rationale"
              level: 1
              content: "Explain the final decision"

      gates:
        proposal_selected:
          target_stage: closed
          locks:
            - type: "equals"
              property_path: "frontmatter.proposal_decision"
              expected_value: "selected"
              error_message: "Decision must be 'selected' to close proposal"

            - exists: "content.sections.decision.selected_solution"
              error_message: "Selected solution must be identified"

            - type: "greater_than"
              property_path: "length(content.sections.decision.selected_solution)"
              expected_value: 0
              error_message: "Selected solution name must be specified"

            - exists: "content.sections.decision.observations"
              error_message: "Decision observations must be documented"

            - type: "greater_than"
              property_path: "length(content.sections.decision.observations)"
              expected_value: 49
              error_message: "Observations must be substantive (at least 50 characters)"

        proposal_requires_split:
          target_stage: split
          locks:
            - type: "equals"
              property_path: "frontmatter.proposal_decision"
              expected_value: "split"
              error_message: "Decision must be 'split' to move to splitting stage"

            - exists: "content.sections.decision.observations"
              error_message: "Decision observations must explain why splitting is necessary"

            - type: "greater_than"
              property_path: "length(content.sections.decision.observations)"
              expected_value: 99
              error_message: "Split rationale must be detailed (at least 100 characters)"

        proposal_requires_rethink:
          target_stage: drafting
          locks:
            - type: "equals"
              property_path: "frontmatter.proposal_decision"
              expected_value: "rethink"
              error_message: "Decision must be 'rethink' to return to drafting"

            - exists: "content.sections.decision.observations"
              error_message: "Decision observations must explain why rethinking is needed"

            - type: "greater_than"
              property_path: "length(content.sections.decision.observations)"
              expected_value: 99
              error_message: "Rethink rationale must be detailed (at least 100 characters)"


    # ==================================================================
    # STAGE: Split - Decompose complex proposal into smaller ones
    # ==================================================================
    split:
      # Expected actions following StageFlow schema
      expected_actions:
        - description: "Create Child Proposals"
          related_properties:
            - "split.child_proposals"
          template: "proposal_split"  # Singular, references template by name

        - description: "Document Splitting Strategy"
          related_properties:
            - "split.strategy"
          template: "proposal_split"  # Singular, references template by name

        - description: "Verify Coverage"
          related_properties:
            - "split.coverage_verified"

        - description: "Complete Split"
          related_properties:
            - "split.completed"
            - "split.completed_at"
            - "split.completed_by"

      # Templates defined as array following StageFlow schema
      templates:
        - name: "proposal_split"
          description: "Template for splitting proposals"
          sections:
            - id: "child_proposals"
              title: "Child Proposals"
              level: 1
              content: "List child proposal IDs and descriptions"
            - id: "coverage_verification"
              title: "Coverage Verification"
              level: 1
              content: "Verify all aspects are covered by child proposals"

      gates:
        split_completed:
          target_stage: closed
          locks:
            - exists: "split.child_proposals"
              error_message: "Child proposals must be created"

            - type: "greater_than"
              property_path: "length(split.child_proposals)"
              expected_value: 1
              error_message: "At least 2 child proposals must be created when splitting"

            - exists: "split.strategy"
              error_message: "Splitting strategy must be documented"

            - type: "greater_than"
              property_path: "length(split.strategy)"
              expected_value: 49
              error_message: "Splitting strategy must be substantive (at least 50 characters)"

            - type: "equals"
              property_path: "split.coverage_verified"
              expected_value: true
              error_message: "Child proposal coverage must be verified to ensure nothing is missed"

            - type: "equals"
              property_path: "split.completed"
              expected_value: true
              error_message: "Split process must be completed before closing"

            - exists: "split.completed_at"
              error_message: "Split completion timestamp must be recorded"

            - exists: "split.completed_by"
              error_message: "Person completing split must be recorded"

    # ==================================================================
    # STAGE: Closed - Terminal stage (approved, rejected, or split)
    # ==================================================================
    closed:
      # No actions in terminal stage
      expected_actions: []

      # No templates needed for terminal stage
      templates: []

      # Terminal stage - no gates
      gates: {}
