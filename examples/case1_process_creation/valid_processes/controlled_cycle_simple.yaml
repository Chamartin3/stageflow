# Example: Simple Controlled Cycle with Iteration Counter
# Use Case: Payment retry with maximum 3 attempts

process:
  name: payment_retry_simple
  initial_stage: initiate
  final_stage: closed

  # Cycle control configuration
  cycle_control:
    enabled: true
    strategy: iteration_counter
    iteration_property: "attempt_number"
    default_max_iterations: 3

  stages:
    initiate:
      gates:
        process:
          target_stage: processing
          locks:
          - exists: "payment.amount"
          - type: greater_than
            property_path: "payment.amount"
            expected_value: 0

      fields:
      - payment.amount
      - attempt_number

    processing:
      gates:
        # Success path
        success:
          target_stage: completed
          locks:
          - type: equals
            property_path: "payment.status"
            expected_value: "success"

        # CYCLE: Retry on failure (back to initiate)
        retry:
          target_stage: initiate
          increment_property: "attempt_number"
          locks:
          - type: equals
            property_path: "payment.status"
            expected_value: "failed"
          - type: less_than
            property_path: "attempt_number"
            expected_value: 3    # Max 3 attempts

        # Give up after max attempts
        give_up:
          target_stage: failed
          locks:
          - type: equals
            property_path: "payment.status"
            expected_value: "failed"
          - type: greater_than
            property_path: "attempt_number"
            expected_value: 2    # After 3rd attempt

      fields:
      - payment.status
      - attempt_number

    completed:
      gates:
        close_completed:
          target_stage: closed
          locks:
          - exists: "closing_reason"
      fields:
      - payment.status
      - payment.transaction_id
      - closing_reason

    failed:
      gates:
        close_failed:
          target_stage: closed
          locks:
          - exists: "closing_reason"
      fields:
      - payment.status
      - payment.error_message
      - closing_reason

    closed:
      fields:
      - closing_reason
      - closed_at

  metadata:
    description: "Simple payment retry process with iteration counter"
    version: "1.0.0"
