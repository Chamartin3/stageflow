# StageFlow Process Definition: Content Moderation Pipeline
# An advanced process demonstrating AI/human hybrid moderation with appeals
# This example shows automated screening, human review, and appeals handling

process:
  name: content_moderation_pipeline
  initial_stage: content_submitted
  final_stage: content_published

  stages:
    content_submitted:
      # User submits content for publication
      schema:
        name: content_submitted_schema
        required_fields:
          - content_id
          - user_id
          - content_type
          - content_body
          - submission_timestamp
        optional_fields:
          - title
          - tags
          - target_audience
          - content_metadata
        validation_rules:
          content_type:
            validator: in_list
            values: ["text", "image", "video", "audio", "document"]
          content_body:
            validator: non_empty
          user_id:
            validator: valid_user

      gates:
        automated_screening:
          target_stage: ai_analysis
          locks:
            - name: content_received
              type: EXISTS
              property: "content.file_url"
              description: "Content file must be accessible"

            - name: user_verified
              type: EQUALS
              property: "user.verification_status"
              benchmark: "verified"
              description: "User account must be verified"

            - name: content_format_valid
              type: CUSTOM
              property: "content.format"
              validator: "supported_format"
              description: "Content must be in supported format"

        # Fast track for trusted users
        trusted_user_bypass:
          target_stage: content_published
          locks:
            - name: user_trusted_status
              type: EQUALS
              property: "user.trust_level"
              benchmark: "trusted"
              description: "User has trusted status"

            - name: content_type_allowed
              type: IN_LIST
              property: "content_type"
              benchmark: ["text", "document"]
              description: "Only text/documents bypass screening"

            - name: no_sensitive_keywords
              type: CUSTOM
              property: "content_body"
              validator: "keyword_scan"
              description: "Content must not contain flagged keywords"

    ai_analysis:
      # Automated AI analysis of content
      schema:
        name: ai_analysis_schema
        required_fields:
          - content_id
          - user_id
          - content_type
          - content_body
          - ai_analysis

      gates:
        ai_approval:
          target_stage: content_published
          locks:
            - name: ai_analysis_complete
              type: EXISTS
              property: "ai_analysis.completed_at"
              description: "AI analysis must be completed"

            - name: ai_confidence_high
              type: GREATER_THAN
              property: "ai_analysis.confidence_score"
              benchmark: 0.85
              description: "AI confidence must be above 85%"

            - name: no_policy_violations
              type: EQUALS
              property: "ai_analysis.policy_violations"
              benchmark: []
              description: "No policy violations detected"

            - name: toxicity_score_acceptable
              type: LESS_THAN
              property: "ai_analysis.toxicity_score"
              benchmark: 0.3
              description: "Toxicity score must be below 30%"

        human_review_required:
          target_stage: pending_human_review
          locks:
            - name: ai_analysis_complete
              type: EXISTS
              property: "ai_analysis.completed_at"
              description: "AI analysis must be completed first"

            - name: flagged_for_review
              type: OR
              conditions:
                - type: LESS_THAN
                  property: "ai_analysis.confidence_score"
                  benchmark: 0.85
                - type: NOT_EQUALS
                  property: "ai_analysis.policy_violations"
                  benchmark: []
                - type: GREATER_THAN_OR_EQUAL
                  property: "ai_analysis.toxicity_score"
                  benchmark: 0.3
              description: "Content flagged for human review"

        ai_rejection:
          target_stage: content_rejected
          locks:
            - name: clear_policy_violation
              type: GREATER_THAN
              property: "ai_analysis.violation_severity"
              benchmark: 0.9
              description: "Clear policy violation detected"

            - name: high_toxicity
              type: GREATER_THAN
              property: "ai_analysis.toxicity_score"
              benchmark: 0.8
              description: "Extremely high toxicity detected"

    pending_human_review:
      # Content waiting for human moderator review
      schema:
        name: pending_human_review_schema
        required_fields:
          - content_id
          - user_id
          - content_type
          - content_body
          - ai_analysis
          - review_queue

      gates:
        moderator_assignment:
          target_stage: under_human_review
          locks:
            - name: moderator_assigned
              type: EXISTS
              property: "review.moderator_id"
              description: "Human moderator must be assigned"

            - name: review_priority_set
              type: EXISTS
              property: "review.priority_level"
              description: "Review priority must be determined"

            - name: sla_deadline_set
              type: EXISTS
              property: "review.sla_deadline"
              description: "SLA deadline must be calculated"

        # Escalation for high-priority content
        escalated_review:
          target_stage: senior_review
          locks:
            - name: high_priority_content
              type: EQUALS
              property: "review.priority_level"
              benchmark: "urgent"
              description: "High-priority content needs senior review"

            - name: senior_moderator_assigned
              type: EXISTS
              property: "review.senior_moderator_id"
              description: "Senior moderator must be assigned"

    under_human_review:
      # Content actively being reviewed by human moderator
      schema:
        name: under_human_review_schema
        required_fields:
          - content_id
          - user_id
          - content_type
          - content_body
          - ai_analysis
          - review

      gates:
        human_approval:
          target_stage: content_published
          locks:
            - name: review_completed
              type: EXISTS
              property: "review.completed_at"
              description: "Human review must be completed"

            - name: moderator_approved
              type: EQUALS
              property: "review.decision"
              benchmark: "approve"
              description: "Moderator approved the content"

            - name: review_notes_provided
              type: EXISTS
              property: "review.notes"
              description: "Review notes must be provided"

        human_rejection:
          target_stage: content_rejected
          locks:
            - name: review_completed
              type: EXISTS
              property: "review.completed_at"
              description: "Human review must be completed"

            - name: moderator_rejected
              type: EQUALS
              property: "review.decision"
              benchmark: "reject"
              description: "Moderator rejected the content"

            - name: rejection_reason_provided
              type: EXISTS
              property: "review.rejection_reason"
              description: "Rejection reason must be provided"

        review_escalation:
          target_stage: senior_review
          locks:
            - name: escalated_by_moderator
              type: EQUALS
              property: "review.decision"
              benchmark: "escalate"
              description: "Moderator escalated to senior review"

            - name: escalation_reason_provided
              type: EXISTS
              property: "review.escalation_reason"
              description: "Escalation reason must be provided"

    senior_review:
      # Content under senior moderator review
      schema:
        name: senior_review_schema
        required_fields:
          - content_id
          - user_id
          - content_type
          - content_body
          - ai_analysis
          - review
          - senior_review

      gates:
        senior_decision:
          target_stage: content_published
          locks:
            - name: senior_review_completed
              type: EXISTS
              property: "senior_review.completed_at"
              description: "Senior review must be completed"

            - name: senior_approved
              type: EQUALS
              property: "senior_review.decision"
              benchmark: "approve"
              description: "Senior moderator approved content"

            - name: senior_notes_provided
              type: EXISTS
              property: "senior_review.notes"
              description: "Senior review notes must be provided"

        senior_rejection:
          target_stage: content_rejected
          locks:
            - name: senior_review_completed
              type: EXISTS
              property: "senior_review.completed_at"
              description: "Senior review must be completed"

            - name: senior_rejected
              type: EQUALS
              property: "senior_review.decision"
              benchmark: "reject"
              description: "Senior moderator rejected content"

            - name: final_rejection_reason
              type: EXISTS
              property: "senior_review.rejection_reason"
              description: "Final rejection reason must be provided"

    content_rejected:
      # Content has been rejected
      schema:
        name: content_rejected_schema
        required_fields:
          - content_id
          - user_id
          - rejection_reason
          - rejected_at
        validation_rules:
          status:
            validator: equals
            value: "rejected"

      gates:
        appeal_submission:
          target_stage: appeal_review
          locks:
            - name: appeal_submitted
              type: EXISTS
              property: "appeal.submitted_at"
              description: "User submitted an appeal"

            - name: appeal_within_timeframe
              type: CUSTOM
              property: "appeal.submitted_at"
              validator: "within_appeal_window"
              description: "Appeal must be submitted within allowed timeframe"

            - name: appeal_reason_provided
              type: EXISTS
              property: "appeal.reason"
              description: "Appeal reason must be provided"

        # Final rejection - no appeals or appeal window expired
        final_rejection:
          target_stage: permanently_rejected
          locks:
            - name: appeal_window_expired
              type: CUSTOM
              property: "rejected_at"
              validator: "appeal_window_expired"
              description: "Appeal window has expired"

    appeal_review:
      # User appeal is being reviewed
      schema:
        name: appeal_review_schema
        required_fields:
          - content_id
          - user_id
          - rejection_reason
          - appeal
          - appeal_review_queue

      gates:
        appeal_decision:
          target_stage: content_published
          locks:
            - name: appeal_reviewed
              type: EXISTS
              property: "appeal_review.completed_at"
              description: "Appeal review must be completed"

            - name: appeal_upheld
              type: EQUALS
              property: "appeal_review.decision"
              benchmark: "upheld"
              description: "Appeal was upheld - content approved"

            - name: appeal_reviewer_assigned
              type: EXISTS
              property: "appeal_review.reviewer_id"
              description: "Appeal reviewer must be assigned"

        appeal_denied:
          target_stage: permanently_rejected
          locks:
            - name: appeal_reviewed
              type: EXISTS
              property: "appeal_review.completed_at"
              description: "Appeal review must be completed"

            - name: appeal_denied
              type: EQUALS
              property: "appeal_review.decision"
              benchmark: "denied"
              description: "Appeal was denied"

    content_published:
      # Final success state - content is live
      schema:
        name: content_published_schema
        required_fields:
          - content_id
          - user_id
          - content_type
          - content_body
          - published_at
        validation_rules:
          status:
            validator: equals
            value: "published"

      # No gates - successful final state

    permanently_rejected:
      # Final rejection state - no further appeals
      schema:
        name: permanently_rejected_schema
        required_fields:
          - content_id
          - user_id
          - rejection_reason
          - final_rejection_at
        validation_rules:
          status:
            validator: equals
            value: "permanently_rejected"

      # No gates - final state

  # Configuration options
  allow_stage_skipping: true  # Trusted users can skip AI analysis
  regression_detection: true

  metadata:
    description: "AI/human hybrid content moderation pipeline with appeals process"
    version: "1.0.0"
    author: "StageFlow Examples"
    use_case: "content_moderation"
    complexity: "advanced"
    estimated_duration: "minutes to days depending on review requirements"
    business_rules:
      - "Trusted users with simple content can bypass moderation"
      - "AI handles initial screening with confidence thresholds"
      - "Human review required for borderline or complex content"
      - "Senior review for high-priority or escalated content"
      - "Appeals process available for rejected content"
      - "Appeal window expires after defined timeframe"
      - "SLA requirements for different priority levels"