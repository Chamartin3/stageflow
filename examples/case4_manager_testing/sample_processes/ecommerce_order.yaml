process:
  name: "ecommerce_order"
  description: "E-commerce order processing workflow"
  initial_stage: "cart"
  final_stage: "delivered"

  stages:
    cart:
      name: "Shopping Cart"
      description: "Items in shopping cart"
      gates:
        proceed_to_checkout:
          target_stage: "checkout"
          locks:
          - type: exists
            property_path: "cart_id"
          - type: exists
            property_path: "items"
          - type: exists
            property_path: "customer_id"
          - type: not_empty
            property_path: "items"

      fields:
      - cart_id
      - items
      - customer_id

    checkout:
      name: "Checkout"
      description: "Customer provides payment and shipping info"
      gates:
        place_order:
          target_stage: "payment_processing"
          locks:
          - type: exists
            property_path: "shipping_address"
          - type: exists
            property_path: "payment_method"
          - type: exists
            property_path: "total_amount"
          - type: greater_than
            property_path: "total_amount"
            expected_value: 0.0

      fields:
      - shipping_address
      - payment_method
      - total_amount

    payment_processing:
      name: "Payment Processing"
      description: "Processing payment for the order"
      gates:
        payment_successful:
          target_stage: "confirmed"
          locks:
          - type: exists
            property_path: "order_id"
          - type: equals
            property_path: "payment_status"
            expected_value: "completed"
          - type: exists
            property_path: "payment.transaction_id"

        payment_failed:
          target_stage: "payment_failed"
          locks:
          - type: equals
            property_path: "payment_status"
            expected_value: "failed"

      fields:
      - order_id
      - payment_status
      - payment
      - payment.transaction_id

    payment_failed:
      name: "Payment Failed"
      description: "Payment was declined or failed"
      gates:
        retry_payment:
          target_stage: "payment_processing"
          locks:
          - type: equals
            property_path: "retry_available"
            expected_value: true
          - type: exists
            property_path: "payment_method"

      fields:
      - failure_reason
      - retry_available
      - payment_method

    confirmed:
      name: "Order Confirmed"
      description: "Order confirmed and ready for fulfillment"
      gates:
        start_fulfillment:
          target_stage: "fulfillment"
          locks:
          - type: exists
            property_path: "confirmed_at"
          - type: exists
            property_path: "fulfillment.assigned_warehouse"

      fields:
      - confirmed_at
      - estimated_delivery
      - fulfillment
      - fulfillment.assigned_warehouse

    fulfillment:
      name: "Fulfillment"
      description: "Order being prepared and shipped"
      gates:
        order_shipped:
          target_stage: "shipped"
          locks:
          - type: equals
            property_path: "fulfillment.status"
            expected_value: "shipped"
          - type: exists
            property_path: "fulfillment.tracking_number"
          - type: exists
            property_path: "shipped_at"

      fields:
      - fulfillment
      - fulfillment.warehouse
      - fulfillment.status
      - fulfillment.tracking_number
      - shipped_at

    shipped:
      name: "Shipped"
      description: "Order has been shipped to customer"
      gates:
        order_delivered:
          target_stage: "delivered"
          locks:
          - type: exists
            property_path: "delivered_at"
          - type: equals
            property_path: "delivery_status"
            expected_value: "delivered"

      fields:
      - shipped_at
      - tracking_info
      - delivered_at
      - delivery_status

    delivered:
      name: "Delivered"
      description: "Order successfully delivered"
      fields:
      - delivered_at
      - delivery_confirmation

  allow_stage_skipping: false
  regression_detection: true
