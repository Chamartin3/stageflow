process:
  name: "complex_pipeline"
  description: "Complex data processing pipeline with multiple validation stages"
  initial_stage: "data_ingestion"
  final_stage: "completed"

  stages:
    data_ingestion:
      name: "Data Ingestion"
      description: "Raw data ingestion from various sources"
      gates:
        data_validation:
          target_stage: "data_cleaning"
          locks:
          - type: exists
            property_path: "pipeline_id"
          - type: exists
            property_path: "data_source"
          - type: exists
            property_path: "raw_data"
          - type: in_list
            property_path: "data_source"
            expected_value: ["api", "file", "database", "stream"]

      fields:
      - pipeline_id
      - data_source
      - raw_data
      - ingested_at

    data_cleaning:
      name: "Data Cleaning"
      description: "Clean and normalize raw data"
      gates:
        quality_check_passed:
          target_stage: "data_transformation"
          locks:
          - type: exists
            property_path: "cleaned_data"
          - type: exists
            property_path: "quality_score"
          - type: greater_than
            property_path: "quality_score"
            expected_value: 0.79

        quality_check_failed:
          target_stage: "quality_review"
          locks:
          - type: exists
            property_path: "quality_score"
          - type: less_than
            property_path: "quality_score"
            expected_value: 0.8

      fields:
      - cleaned_data
      - cleaning_stats
      - quality_score

    quality_review:
      name: "Quality Review"
      description: "Manual review of data quality issues"
      gates:
        approve_for_processing:
          target_stage: "data_transformation"
          locks:
          - type: exists
            property_path: "review.reviewer"
          - type: equals
            property_path: "review.action_required"
            expected_value: "approve"
          - type: exists
            property_path: "review.approval_reason"

        reject_and_retry:
          target_stage: "data_cleaning"
          locks:
          - type: equals
            property_path: "review.action_required"
            expected_value: "retry"

      fields:
      - review
      - review.reviewer
      - review.issues_identified
      - review.action_required
      - review.approval_reason

    data_transformation:
      name: "Data Transformation"
      description: "Transform data according to business rules"
      gates:
        transformation_complete:
          target_stage: "data_validation"
          locks:
          - type: exists
            property_path: "transformed_data"
          - type: exists
            property_path: "transformation_config"
          - type: exists
            property_path: "schema_version"
          - type: exists
            property_path: "transformation.completed_at"

      fields:
      - transformed_data
      - transformation_config
      - schema_version
      - transformation
      - transformation.completed_at

    data_validation:
      name: "Data Validation"
      description: "Validate transformed data against schema"
      gates:
        validation_passed:
          target_stage: "data_enrichment"
          locks:
          - type: equals
            property_path: "schema_compliance"
            expected_value: true
          - type: equals
            property_path: "validation_errors"
            expected_value: []

        validation_failed:
          target_stage: "validation_review"
          locks:
          - type: equals
            property_path: "schema_compliance"
            expected_value: false

      fields:
      - validation_results
      - schema_compliance
      - validation_errors

    validation_review:
      name: "Validation Review"
      description: "Review validation failures"
      gates:
        fix_validation_issues:
          target_stage: "data_transformation"
          locks:
          - type: equals
            property_path: "review.resolution_plan"
            expected_value: "fix_and_retry"

        override_validation:
          target_stage: "data_enrichment"
          locks:
          - type: equals
            property_path: "review.resolution_plan"
            expected_value: "override"
          - type: exists
            property_path: "review.override_justification"

      fields:
      - review
      - review.validation_reviewer
      - review.error_analysis
      - review.resolution_plan
      - review.override_justification

    data_enrichment:
      name: "Data Enrichment"
      description: "Enrich data with additional information"
      gates:
        enrichment_complete:
          target_stage: "final_processing"
          locks:
          - type: exists
            property_path: "enriched_data"
          - type: exists
            property_path: "enrichment_sources"
          - type: greater_than
            property_path: "enrichment_score"
            expected_value: 0.5

      fields:
      - enriched_data
      - enrichment_sources
      - enrichment_score

    final_processing:
      name: "Final Processing"
      description: "Final processing and output generation"
      gates:
        processing_complete:
          target_stage: "completed"
          locks:
          - type: exists
            property_path: "final_output"
          - type: exists
            property_path: "output_format"
          - type: exists
            property_path: "processed_at"
          - type: in_list
            property_path: "output_format"
            expected_value: ["json", "csv", "parquet", "database"]

      fields:
      - final_output
      - output_format
      - processed_at

    completed:
      name: "Pipeline Completed"
      description: "Data pipeline processing completed successfully"
      fields:
      - completion_status
      - output_location
      - pipeline_metrics

  allow_stage_skipping: false
  regression_detection: true
