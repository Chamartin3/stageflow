# Case 1.1: Complex Multi-Stage Process
# Tests: Complex process with multiple stages and branching paths

process:
  name: ecommerce_order_processing
  initial_stage: cart
  final_stage: completed

  stages:
    cart:
      schema:
        required_fields:
          - items
          - customer_id

      gates:
         proceed_to_checkout:
           target_stage: checkout
           locks:
             - exists: "items"
               error_message: "Shopping cart cannot be empty. Add at least one item before proceeding to checkout."
             - type: not_empty
               property_path: "items"
               error_message: "Shopping cart cannot be empty. Add at least one item before proceeding to checkout."
             - exists: "customer_id"
               error_message: "Customer account is required. Please log in or create an account to continue."

    checkout:
      schema:
        required_fields:
          - items
          - customer_id
          - shipping_address
          - billing_address

      gates:
         submit_payment:
           target_stage: payment_processing
           locks:
             - exists: "shipping_address.street"
               error_message: "Shipping address is required. Please provide a complete shipping address."
             - exists: "billing_address.street"
               error_message: "Billing address is required. Please provide a complete billing address."
             - exists: "payment_method"
               error_message: "Payment method is required. Please select a payment method to complete your order."

    payment_processing:
      schema:
        required_fields:
          - payment_method
          - total_amount

      gates:
        payment_success:
          target_stage: fulfillment
          locks:
            - type: equals
              property_path: "payment_status"
              expected_value: "completed"
              error_message: "Payment must be completed successfully. Please check your payment method and try again."
            - exists: "transaction_id"
              error_message: "Payment transaction ID is required. Contact support if this error persists."

        payment_failed:
          target_stage: payment_retry
          locks:
            - type: equals
              property_path: "payment_status"
              expected_value: "failed"

    payment_retry:
      schema:
        required_fields:
          - payment_method
          - retry_count

      gates:
        retry_payment:
          target_stage: payment_processing
          locks:
            - type: less_than
              property_path: "retry_count"
              expected_value: 3
            - exists: "payment_method"

        payment_abandoned:
          target_stage: abandoned
          locks:
            - type: greater_than
              property_path: "retry_count"
              expected_value: 2

    fulfillment:
      schema:
        required_fields:
          - shipping_carrier
          - tracking_number

      gates:
        order_shipped:
          target_stage: shipped
          locks:
            - exists: "tracking_number"
            - type: not_empty
              property_path: "tracking_number"

    shipped:
      schema:
        required_fields:
          - tracking_number
          - shipped_date

      gates:
        order_delivered:
          target_stage: completed
          locks:
            - exists: "delivery_date"
            - type: equals
              property_path: "delivery_status"
              expected_value: "delivered"

    completed:
      schema:
        required_fields:
          - delivery_date
          - order_status

    abandoned:
      schema:
        required_fields:
          - abandonment_reason
          - abandonment_date

  allow_stage_skipping: false
  regression_detection: true

  metadata:
    description: "Complex e-commerce order processing workflow"
    version: "1.0.0"
    test_case: "valid_complex_multistage"