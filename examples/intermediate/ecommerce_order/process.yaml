# StageFlow Process Definition: E-commerce Order Processing
# An intermediate process demonstrating business logic with branching

process:
  name: ecommerce_order_fulfillment
  initial_stage: order_placed
  final_stage: order_delivered

  stages:
    order_placed:
      # Customer has placed an order
      schema:
        name: order_placed_schema
        required_fields:
          - order_id
          - customer_id
          - items
          - total_amount
          - shipping_address

      gates:
        payment_processing:
          target_stage: payment_processed
          locks:
            - name: payment_method_valid
              type: exists
              property: "payment.method"
              description: "Valid payment method must be provided"

            - name: payment_amount_matches
              type: equals
              property: "payment.amount"
              benchmark: "total_amount"
              description: "Payment amount must match order total"

            - name: payment_authorized
              type: exists
              property: "payment.authorization_code"
              description: "Payment must be authorized by payment processor"

    payment_processed:
      # Payment has been successfully processed
      schema:
        name: payment_processed_schema
        required_fields:
          - order_id
          - customer_id
          - items
          - total_amount
          - shipping_address
          - payment

      gates:
        inventory_check:
          target_stage: inventory_reserved
          locks:
            - name: all_items_available
              type: exists
              property: "inventory.availability"
              description: "All ordered items must be in stock"

    inventory_reserved:
      # Inventory has been reserved for this order
      schema:
        name: inventory_reserved_schema
        required_fields:
          - order_id
          - customer_id
          - items
          - total_amount
          - shipping_address
          - payment
          - inventory

      gates:
        fulfillment_ready:
          target_stage: order_shipped
          locks:
            - name: items_picked
              type: exists
              property: "fulfillment.picked_at"
              description: "Items must be picked from warehouse"

            - name: items_packed
              type: exists
              property: "fulfillment.packed_at"
              description: "Items must be packed for shipping"

            - name: shipping_label_created
              type: exists
              property: "shipping.tracking_number"
              description: "Shipping label and tracking must be generated"

    order_shipped:
      # Order has been shipped to customer
      schema:
        name: order_shipped_schema
        required_fields:
          - order_id
          - customer_id
          - items
          - total_amount
          - shipping_address
          - payment
          - inventory
          - fulfillment
          - shipping

      gates:
        delivery_confirmation:
          target_stage: order_delivered
          locks:
            - name: package_delivered
              type: exists
              property: "shipping.delivered_at"
              description: "Package must be marked as delivered"

            - name: delivery_confirmed
              type: equals
              property: "shipping.delivery_status"
              benchmark: "delivered"
              description: "Delivery status must be confirmed"

    order_delivered:
      # Final success state - order completed successfully
      schema:
        name: order_delivered_schema
        required_fields:
          - order_id
          - customer_id
          - items
          - total_amount
          - shipping_address
          - payment
          - inventory
          - fulfillment
          - shipping

      # No gates - successful final state

    order_cancelled:
      # Final state for cancelled orders
      schema:
        name: order_cancelled_schema
        required_fields:
          - order_id
          - customer_id
          - cancellation_reason

      # No gates - final state

  # Configuration options
  allow_stage_skipping: false
  regression_detection: true

  metadata:
    description: "E-commerce order processing from placement to delivery"
    version: "1.0.0"
    author: "StageFlow Examples"
    use_case: "e-commerce"
    complexity: "intermediate"