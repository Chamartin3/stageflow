process:
  name: "document_approval"
  description: "Document approval workflow with review stages"
  initial_stage: "draft"
  final_stage: "published"

  stages:
    draft:
      name: "Draft"
      description: "Document is in draft status"
      gates:
        submit_for_review:
          target_stage: "under_review"
          locks:
          - type: exists
            property_path: "document_id"
          - type: exists
            property_path: "title"
          - type: exists
            property_path: "content"
          - type: exists
            property_path: "author"
          - type: not_empty
            property_path: "content"

      fields:
      - document_id
      - title
      - content
      - author

    under_review:
      name: "Under Review"
      description: "Document is being reviewed"
      gates:
        approve_document:
          target_stage: "approved"
          locks:
          - type: exists
            property_path: "review.decision"
          - type: equals
            property_path: "review.decision"
            expected_value: "approved"
          - type: exists
            property_path: "review.completed_at"

        request_changes:
          target_stage: "needs_revision"
          locks:
          - type: exists
            property_path: "review.decision"
          - type: equals
            property_path: "review.decision"
            expected_value: "changes_requested"
          - type: exists
            property_path: "review.feedback"

      fields:
      - assigned_reviewer
      - review_started_at
      - review
      - review.decision
      - review.completed_at
      - review.feedback

    needs_revision:
      name: "Needs Revision"
      description: "Document needs changes before approval"
      gates:
        resubmit_after_revision:
          target_stage: "under_review"
          locks:
          - type: exists
            property_path: "revision.completed"
          - type: equals
            property_path: "revision.completed"
            expected_value: true
          - type: exists
            property_path: "revision.changes_made"

      fields:
      - review
      - review.feedback
      - review.requested_changes
      - revision
      - revision.completed
      - revision.changes_made

    approved:
      name: "Approved"
      description: "Document has been approved"
      gates:
        publish_document:
          target_stage: "published"
          locks:
          - type: exists
            property_path: "approved_by"
          - type: exists
            property_path: "approved_at"
          - type: exists
            property_path: "publish_ready"
          - type: equals
            property_path: "publish_ready"
            expected_value: true

      fields:
      - approved_by
      - approved_at
      - publish_ready

    published:
      name: "Published"
      description: "Document has been published"
      fields:
      - published_at
      - publication_url

  allow_stage_skipping: false
  regression_detection: true
