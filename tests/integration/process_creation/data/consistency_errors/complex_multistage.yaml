# Case 1.6: Complex Multi-Stage Process
# Tests: Complex e-commerce order processing workflow
# Expected: Process loads but may have consistency issues

process:
  name: complex_multistage
  description: "Complex multi-stage ecommerce order processing"
  initial_stage: cart
  final_stage: completed

  stages:
    cart:
      gates:
        add_to_cart:
          target_stage: checkout
          locks:
            - exists: "items"
            - type: not_empty
              property_path: "items"
            - exists: "customer_id"

    checkout:
      gates:
        submit_payment:
          target_stage: payment_processing
          locks:
            - exists: "shipping_address.street"
            - exists: "billing_address.street"
            - exists: "payment_method"

    payment_processing:
      gates:
        payment_success:
          target_stage: fulfillment
          locks:
            - type: equals
              property_path: "payment_status"
              expected_value: "completed"
            - exists: "transaction_id"

        payment_failed:
          target_stage: payment_retry
          locks:
            - type: equals
              property_path: "payment_status"
              expected_value: "failed"

    payment_retry:
      gates:
        retry_payment:
          target_stage: payment_processing
          locks:
            - type: less_than
              property_path: "retry_count"
              expected_value: 3
            - exists: "payment_method"

        payment_abandoned:
          target_stage: abandoned
          locks:
            - type: greater_than
              property_path: "retry_count"
              expected_value: 2

    fulfillment:
      gates:
        order_shipped:
          target_stage: shipped
          locks:
            - exists: "tracking_number"
            - type: not_empty
              property_path: "tracking_number"

    shipped:
      gates:
        order_delivered:
          target_stage: completed
          locks:
            - exists: "delivery_date"
            - type: equals
              property_path: "delivery_status"
              expected_value: "delivered"

    completed:
      gates: []

    abandoned:
      gates: []

  allow_stage_skipping: false
  regression_detection: true

  metadata:
    description: "Complex e-commerce order processing workflow"
    version: "1.0.0"
    test_case: "valid_complex_multistage"